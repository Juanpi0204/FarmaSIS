<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nuevo Suministro - L-FARMA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .product-item {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 1rem;
            background-color: #f8f9fa;
        }
        .product-item:hover {
            background-color: #e9ecef;
        }
        .total-display {
            font-size: 1.5rem;
            font-weight: bold;
            color: #198754;
        }
    </style>
</head>
<body>
<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-success">
    <div class="container">
        <a class="navbar-brand" href="#">
            <i class="fas fa-shipping-fast"></i> L-FARMA - Nuevo Suministro
        </a>
        <div class="navbar-nav ms-auto">
            <a class="nav-link" href="/suministros">
                <i class="fas fa-arrow-left"></i> Volver a Suministros
            </a>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-plus"></i> Registrar Nuevo Suministro
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Alertas -->
                    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="fas fa-exclamation-triangle"></i> <span th:text="${error}"></span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>

                    <form th:action="@{/suministros/guardar}" method="post" id="suministroForm">
                        <!-- Información del Proveedor -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5><i class="fas fa-truck text-primary"></i> Información del Proveedor</h5>
                                <hr>
                            </div>
                            <div class="col-md-6">
                                <label for="proveedorId" class="form-label">Seleccionar Proveedor *</label>
                                <select class="form-select" id="proveedorId" name="proveedorId" required>
                                    <option value="">-- Seleccionar Proveedor --</option>
                                    <option th:each="proveedor : ${proveedores}"
                                            th:value="${proveedor.id}"
                                            th:text="${proveedor.nombre} + ' (' + ${proveedor.codigo} + ')'">
                                    </option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Acciones Rápidas</label>
                                <div>
                                    <a th:href="@{/proveedores/nuevo}" class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-plus"></i> Nuevo Proveedor
                                    </a>
                                    <a th:href="@{/proveedores}" class="btn btn-outline-info btn-sm">
                                        <i class="fas fa-list"></i> Ver Todos
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- Productos del Suministro -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5><i class="fas fa-boxes text-warning"></i> Productos del Suministro</h5>
                                    <button type="button" class="btn btn-success btn-sm" onclick="agregarProducto()">
                                        <i class="fas fa-plus"></i> Agregar Producto
                                    </button>
                                </div>
                                <hr>
                            </div>
                        </div>

                        <!-- Lista de Productos -->
                        <div id="productosContainer">
                            <!-- Los productos se agregarán dinámicamente aquí -->
                        </div>

                        <!-- Totales -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <strong>Total Productos:</strong>
                                                <span id="totalProductos" class="total-display">0</span>
                                            </div>
                                            <div class="col-md-4">
                                                <strong>Total Unidades:</strong>
                                                <span id="totalUnidades" class="total-display">0</span>
                                            </div>
                                            <div class="col-md-4">
                                                <strong>Valor Total:</strong>
                                                <span id="valorTotal" class="total-display">$0.00</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Observaciones -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <label for="observaciones" class="form-label">Observaciones</label>
                                <textarea class="form-control" id="observaciones" name="observaciones"
                                          rows="3" placeholder="Observaciones adicionales sobre el suministro..."></textarea>
                            </div>
                        </div>

                        <!-- Botones -->
                        <div class="row">
                            <div class="col-12">
                                <button type="submit" class="btn btn-success btn-lg me-2">
                                    <i class="fas fa-save"></i> Registrar Suministro y Actualizar Stock
                                </button>
                                <a th:href="@{/suministros}" class="btn btn-secondary btn-lg">
                                    <i class="fas fa-times"></i> Cancelar
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Template para Producto -->
<template id="productoTemplate">
    <div class="product-item">
        <div class="row g-3">
            <div class="col-md-4">
                <label class="form-label">Producto *</label>
                <select class="form-select producto-select" name="productoIds" required onchange="actualizarPrecios(this)">
                    <option value="">-- Seleccionar Producto --</option>
                    <option th:each="producto : ${productos}"
                            th:value="${producto.id}"
                            th:data-precio="${producto.precio}"
                            th:data-costo="${producto.costoCompra}"
                            th:text="${producto.nombre} + ' (' + ${producto.codigo} + ')'">
                    </option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Cantidad *</label>
                <input type="number" class="form-control cantidad-input" name="cantidades"
                       min="1" value="1" required onchange="calcularTotales()">
            </div>
            <div class="col-md-2">
                <label class="form-label">Precio Compra *</label>
                <input type="number" class="form-control precio-compra-input" name="preciosCompra"
                       step="0.01" min="0" required onchange="calcularTotales()">
            </div>
            <div class="col-md-2">
                <label class="form-label">Precio Venta</label>
                <input type="number" class="form-control precio-venta-input" name="preciosVenta"
                       step="0.01" min="0" onchange="calcularTotales()">
            </div>
            <div class="col-md-1">
                <label class="form-label">Lote</label>
                <input type="text" class="form-control" name="lotes" placeholder="Lote">
            </div>
            <div class="col-md-1">
                <label class="form-label">&nbsp;</label>
                <button type="button" class="btn btn-danger btn-sm w-100" onclick="eliminarProducto(this)">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-12">
                <small class="text-muted">
                    Subtotal: $<span class="subtotal">0.00</span> |
                    Ganancia: $<span class="ganancia">0.00</span>
                </small>
            </div>
        </div>
    </div>
</template>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let productoCount = 0;

    // Agregar producto al formulario
    function agregarProducto() {
        const template = document.getElementById('productoTemplate');
        const clone = template.content.cloneNode(true);
        const container = document.getElementById('productosContainer');

        container.appendChild(clone);
        productoCount++;

        // Actualizar contadores
        document.getElementById('totalProductos').textContent = productoCount;
        calcularTotales();
    }

    // Eliminar producto del formulario
    function eliminarProducto(button) {
        const productItem = button.closest('.product-item');
        productItem.remove();
        productoCount--;

        document.getElementById('totalProductos').textContent = productoCount;
        calcularTotales();
    }

    // Actualizar precios cuando se selecciona un producto
    function actualizarPrecios(select) {
        const selectedOption = select.options[select.selectedIndex];
        const precioCompra = selectedOption.getAttribute('data-costo');
        const precioVenta = selectedOption.getAttribute('data-precio');

        const item = select.closest('.product-item');
        item.querySelector('.precio-compra-input').value = precioCompra || '';
        item.querySelector('.precio-venta-input').value = precioVenta || '';

        calcularTotales();
    }

    // Calcular totales
    function calcularTotales() {
        let totalUnidades = 0;
        let valorTotal = 0;

        document.querySelectorAll('.product-item').forEach(item => {
            const cantidad = parseInt(item.querySelector('.cantidad-input').value) || 0;
            const precioCompra = parseFloat(item.querySelector('.precio-compra-input').value) || 0;
            const precioVenta = parseFloat(item.querySelector('.precio-venta-input').value) || 0;

            const subtotal = cantidad * precioCompra;
            const ganancia = cantidad * (precioVenta - precioCompra);

            // Actualizar subtotales del item
            item.querySelector('.subtotal').textContent = subtotal.toFixed(2);
            item.querySelector('.ganancia').textContent = ganancia.toFixed(2);

            totalUnidades += cantidad;
            valorTotal += subtotal;
        });

        document.getElementById('totalUnidades').textContent = totalUnidades;
        document.getElementById('valorTotal').textContent = '$' + valorTotal.toFixed(2);
    }

    // Validar formulario antes de enviar
    document.getElementById('suministroForm').addEventListener('submit', function(e) {
        if (productoCount === 0) {
            e.preventDefault();
            alert('Debe agregar al menos un producto al suministro');
            return false;
        }

        const proveedor = document.getElementById('proveedorId').value;
        if (!proveedor) {
            e.preventDefault();
            alert('Debe seleccionar un proveedor');
            return false;
        }

        // Validar que todos los productos tengan cantidad y precio
        let valid = true;
        document.querySelectorAll('.product-item').forEach(item => {
            const producto = item.querySelector('.producto-select').value;
            const cantidad = item.querySelector('.cantidad-input').value;
            const precioCompra = item.querySelector('.precio-compra-input').value;

            if (!producto || !cantidad || !precioCompra) {
                valid = false;
            }
        });

        if (!valid) {
            e.preventDefault();
            alert('Complete todos los campos obligatorios de los productos');
            return false;
        }
    });

    // Agregar un producto al cargar la página
    window.onload = function() {
        agregarProducto();
    };
</script>
</body>
</html>