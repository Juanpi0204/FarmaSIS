<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Clientes - L Farma</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css">
    <link rel="stylesheet" href="/clientes.css">
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <!-- Overlay para móviles -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- Sidebar DINÁMICO según rol -->
        <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block sidebar">
            <div class="logo-container d-flex align-items-center">
                <div class="logo">
                    <img src="/f5.jpg" alt="L Farma Logo" class="logo-img">
                </div>
            </div>
            <hr class="sidebar-divider">
            <div class="position-sticky">
                <ul class="nav flex-column">
                    <!-- Para ADMIN -->
                    <th:block th:if="${esAdmin}">
                        <li class="nav-item">
                            <a class="nav-link" href="/dashboard_admin">
                                <i class='bx bxs-dashboard'></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/productos/registrar-productos">
                                <i class='bx bx-package'></i> Registrar Productos
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/productos">
                                <i class='bx bx-layer'></i> Visualizar Productos
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/facturas/crear">
                                <i class='bx bx-receipt'></i> Generación de Ventas
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/facturas">
                                <i class='bx bx-chart'></i> Visualización de Ventas
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="/clientes">
                                <i class='bx bx-group'></i> Clientes
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/predicciones">
                                <i class='bx bx-brain'></i> Predicciones IA
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/predicciones/dashboard">
                                <i class='bx bx-stats'></i> Dashboard IA
                            </a>
                        </li>
                    </th:block>

                    <!-- Para EMPLEADO -->
                    <th:block th:unless="${esAdmin}">
                        <li class="nav-item">
                            <a class="nav-link" href="/dashboard_empleado">
                                <i class='bx bxs-dashboard'></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/productos">
                                <i class='bx bx-layer'></i> Visualizar Productos
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/facturas/crear">
                                <i class='bx bx-receipt'></i> Generación de Ventas
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/facturas">
                                <i class='bx bx-chart'></i> Visualización de Ventas
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="/clientes">
                                <i class='bx bx-group'></i> Clientes
                            </a>
                        </li>
                    </th:block>
                </ul>
            </div>
        </nav>

        <!-- Botón toggle fijo -->
        <button id="toggleSidebar" class="fixed-toggle-btn">
            <i class="bx bx-menu"></i>
        </button>

       <!-- Botón de cerrar sesión tipo apagado (abre modal) -->
        <button id="logoutBtn" type="button" class="logout-btn" title="Cerrar sesión" data-bs-toggle="modal" data-bs-target="#confirmLogoutModal">
            <i class='bx bx-power-off'></i>
        </button>


        <!-- Main Content -->
        <main id="mainContent" class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="page-title-container fade-in">
                <h1 class="page-title">Gestión de Clientes</h1>
                <p class="page-subtitle" th:text="${esAdmin} ?
                    'Administre la información de los clientes registrados en el sistema' :
                    'Consulte y agregue clientes al sistema'"></p>
            </div>

            <!-- Alertas para mensajes de éxito o error -->
            <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
                <i class='bx bx-check-circle'></i> <span th:text="${success}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class='bx bx-error-circle'></i> <span th:text="${error}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>

            <!-- Estadísticas rápidas -->
            <div class="row fade-in" th:if="${esAdmin}">
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="stats-number" th:text="${totalItems}">0</div>
                        <div class="stats-label">Total Clientes</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <div class="stats-number" th:text="${pageSize}">15</div>
                        <div class="stats-label">Por Página</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <div class="stats-number" th:text="${currentPage + 1}">1</div>
                        <div class="stats-label">Página Actual</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <div class="stats-number" th:text="${totalPages}">1</div>
                        <div class="stats-label">Total Páginas</div>
                    </div>
                </div>
            </div>

            <div class="content-card fade-in">
                <!-- Barra de búsqueda y controles -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <form th:action="@{/clientes}" method="get" class="d-flex">
                            <div class="input-group search-box">
                                <input type="text" name="search" class="form-control"
                                       th:value="${search}"
                                       placeholder="Buscar clientes por nombre, código, email...">
                                <button type="submit" class="btn btn-primary">
                                    <i class='bx bx-search'></i> Buscar
                                </button>
                                <a th:href="@{/clientes}" class="btn btn-outline-secondary" th:if="${search}">
                                    <i class='bx bx-x'></i> Limpiar
                                </a>
                            </div>
                        </form>
                    </div>
                    <div class="col-md-6 text-end">
                        <button type="button" class="btn btn-primary btn-add-client me-2" data-bs-toggle="modal" data-bs-target="#agregarClienteModal">
                            <i class='bx bx-plus'></i> Agregar Cliente
                        </button>
                        <button type="button" class="btn btn-reload" id="reloadBtn" title="Recargar lista">
                            <i class='bx bx-refresh'></i>
                        </button>
                        <span class="ms-3 text-muted">
                            <i class='bx bx-info-circle'></i>
                            Mostrando <strong th:text="${clientes.size()}">0</strong> de <strong th:text="${totalItems}">0</strong> clientes
                        </span>
                    </div>
                </div>

                <!-- Loading spinner -->
                <div class="loading-spinner" id="loadingSpinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-2">Cargando clientes...</p>
                </div>

                <!-- Tabla de clientes -->
                <div class="table-responsive" id="clientesTable">
                    <table class="table table-hover">
                        <thead>
                        <tr>
                            <th>Código</th>
                            <th>Nombre</th>
                            <th>Email</th>
                            <th>Teléfono</th>
                            <th>Identificación</th>
                            <th>Dirección</th>
                            <th class="action-buttons">Acciones</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="cliente : ${clientes}" class="client-card">
                            <td>
                                <strong th:text="${cliente.codigo}"></strong>
                            </td>
                            <td th:text="${cliente.nombre}"></td>
                            <td>
                                <span th:text="${cliente.email} ?: 'No registrado'"
                                      th:class="${cliente.email} ? '' : 'text-muted'"></span>
                                <th:block th:if="${cliente.email}">
                                    <br><small class="text-muted"><i class='bx bx-envelope'></i></small>
                                </th:block>
                            </td>
                            <td>
                                <span th:text="${cliente.telefono} ?: 'No registrado'"
                                      th:class="${cliente.telefono} ? '' : 'text-muted'"></span>
                                <th:block th:if="${cliente.telefono}">
                                    <br><small class="text-muted"><i class='bx bx-phone'></i></small>
                                </th:block>
                            </td>
                            <td th:text="${cliente.identificacion} ?: 'No disponible'"
                                th:class="${cliente.identificacion} ? '' : 'text-muted'"></td>
                            <td>
                                <th:block th:if="${cliente.direccion}">
                                    <span th:text="${cliente.direccion}"></span>
                                    <br>
                                    <span class="badge bg-success badge-address">
                                        <i class='bx bx-map'></i> Con dirección
                                    </span>
                                </th:block>
                                <th:block th:unless="${cliente.direccion}">
                                    <span class="text-muted">No registrada</span>
                                    <br>
                                    <span class="badge bg-warning badge-address">
                                        <i class='bx bx-map-alt'></i> Sin dirección
                                    </span>
                                </th:block>
                            </td>
                            <td class="action-buttons">
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-view btn-action view-client-btn"
                                            data-bs-toggle="modal"
                                            data-bs-target="#verClienteModal"
                                            th:attr="data-codigo=${cliente.codigo},
                                                     data-nombre=${cliente.nombre},
                                                     data-email=${cliente.email},
                                                     data-telefono=${cliente.telefono},
                                                     data-identificacion=${cliente.identificacion},
                                                     data-direccion=${cliente.direccion}">
                                        <i class='bx bx-show'></i>
                                    </button>
                                    <!-- Botones de edición/eliminación solo para admin -->
                                    <th:block th:if="${esAdmin}">
                                        <button type="button" class="btn btn-warning btn-action admin-only edit-client-btn"
                                                data-bs-toggle="modal"
                                                data-bs-target="#editarClienteModal"
                                                th:attr="data-codigo=${cliente.codigo},
                                                         data-nombre=${cliente.nombre},
                                                         data-email=${cliente.email},
                                                         data-telefono=${cliente.telefono},
                                                         data-identificacion=${cliente.identificacion},
                                                         data-direccion=${cliente.direccion},
                                                         data-username=${cliente.username},
                                                         data-direccionfisica=${cliente.direccionFisica}">
                                            <i class='bx bx-edit'></i>
                                        </button>
                                        <button type="button" class="btn btn-danger btn-action admin-only delete-client-btn"
                                                th:attr="data-codigo=${cliente.codigo}, data-nombre=${cliente.nombre}">
                                            <i class='bx bx-trash'></i>
                                        </button>
                                    </th:block>
                                </div>
                            </td>
                        </tr>
                        <tr th:if="${clientes.empty}">
                            <td colspan="7" class="no-clients">
                                <i class='bx bx-group' style="font-size: 4rem; margin-bottom: 1rem;"></i>
                                <h5>No hay clientes registrados</h5>
                                <p class="text-muted" th:if="${search}">
                                    No se encontraron clientes para "<span th:text="${search}"></span>"
                                </p>
                                <p class="text-muted" th:unless="${search}">
                                    Comience agregando el primer cliente al sistema
                                </p>
                                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#agregarClienteModal">
                                    <i class='bx bx-plus'></i> Agregar Primer Cliente
                                </button>
                                <a th:href="@{/clientes}" class="btn btn-outline-secondary ms-2" th:if="${search}">
                                    <i class='bx bx-x'></i> Limpiar búsqueda
                                </a>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Paginación -->
                <div th:if="${totalPages > 1}" class="pagination-container">
                    <div class="pagination-info">
                        Mostrando página <strong th:text="${currentPage + 1}">1</strong> de
                        <strong th:text="${totalPages}">1</strong> -
                        <strong th:text="${totalItems}">0</strong> clientes en total
                    </div>

                    <nav>
                        <ul class="pagination mb-0">
                            <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled' : ''">
                                <a class="page-link"
                                   th:href="@{/clientes(page=0, size=${pageSize}, search=${search})}">
                                    <i class='bx bx-first-page'></i>
                                </a>
                            </li>
                            <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled' : ''">
                                <a class="page-link"
                                   th:href="@{/clientes(page=${currentPage - 1}, size=${pageSize}, search=${search})}">
                                    <i class='bx bx-chevron-left'></i>
                                </a>
                            </li>

                            <!-- Páginas numeradas -->
                            <li th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                                class="page-item" th:classappend="${i == currentPage} ? 'active' : ''">
                                <a class="page-link"
                                   th:href="@{/clientes(page=${i}, size=${pageSize}, search=${search})}"
                                   th:text="${i + 1}"></a>
                            </li>

                            <li class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'disabled' : ''">
                                <a class="page-link"
                                   th:href="@{/clientes(page=${currentPage + 1}, size=${pageSize}, search=${search})}">
                                    <i class='bx bx-chevron-right'></i>
                                </a>
                            </li>
                            <li class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'disabled' : ''">
                                <a class="page-link"
                                   th:href="@{/clientes(page=${totalPages - 1}, size=${pageSize}, search=${search})}">
                                    <i class='bx bx-last-page'></i>
                                </a>
                            </li>
                        </ul>
                    </nav>

                    <div>
                        <select class="form-select page-size-selector" onchange="changePageSize(this)">
                            <option th:selected="${pageSize == 10}" value="10">10 por página</option>
                            <option th:selected="${pageSize == 15}" value="15">15 por página</option>
                            <option th:selected="${pageSize == 25}" value="25">25 por página</option>
                            <option th:selected="${pageSize == 50}" value="50">50 por página</option>
                            <option th:selected="${pageSize == 100}" value="100">100 por página</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Modal para agregar cliente -->
            <div class="modal fade" id="agregarClienteModal" tabindex="-1" aria-labelledby="agregarClienteLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title" id="agregarClienteLabel">
                                <i class='bx bx-plus'></i> Agregar Nuevo Cliente
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <form id="agregarClienteForm" th:action="@{/clientes/agregar}" method="post">
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="codigo" class="form-label">Código *</label>
                                        <input type="text" class="form-control" id="codigo" name="codigo" required>
                                        <div class="form-text">Código único del cliente</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="nombre" class="form-label">Nombre Completo *</label>
                                        <input type="text" class="form-control" id="nombre" name="nombre" required>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="email" class="form-label">Email</label>
                                        <input type="email" class="form-control" id="email" name="email">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="telefono" class="form-label">Teléfono</label>
                                        <input type="tel" class="form-control" id="telefono" name="telefono">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="identificacion" class="form-label">Identificación *</label>
                                        <input type="text" class="form-control" id="identificacion" name="identificacion" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="direccion" class="form-label">Dirección</label>
                                        <textarea class="form-control" id="direccion" name="direccion" rows="2"></textarea>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="username" class="form-label">Username *</label>
                                        <input type="text" class="form-control" id="username" name="username" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="direccionFisica" class="form-label">Dirección Física</label>
                                        <input type="text" class="form-control" id="direccionFisica" name="direccionFisica">
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="submit" class="btn btn-primary">
                                    <i class='bx bx-save'></i> Guardar Cliente
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Modal para ver cliente -->
            <div class="modal fade" id="verClienteModal" tabindex="-1" aria-labelledby="verClienteLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title" id="verClienteLabel">
                                <i class='bx bx-show'></i> Información del Cliente
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row mb-3">
                                <div class="col-12">
                                    <strong>Código:</strong>
                                    <p id="viewClienteCodigo" class="mb-2">-</p>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-12">
                                    <strong>Nombre:</strong>
                                    <p id="viewClienteNombre" class="mb-2">-</p>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-12">
                                    <strong>Email:</strong>
                                    <p id="viewClienteEmail" class="mb-2">-</p>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-12">
                                    <strong>Teléfono:</strong>
                                    <p id="viewClienteTelefono" class="mb-2">-</p>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-12">
                                    <strong>Identificación:</strong>
                                    <p id="viewClienteIdentificacion" class="mb-2">-</p>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12">
                                    <strong>Dirección:</strong>
                                    <p id="viewClienteDireccion" class="mb-0">-</p>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal para editar cliente -->
            <div class="modal fade" id="editarClienteModal" tabindex="-1" aria-labelledby="editarClienteLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-warning text-white">
                            <h5 class="modal-title" id="editarClienteLabel">
                                <i class='bx bx-edit'></i> Editar Cliente
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <form id="editarClienteForm" th:action="@{/clientes/actualizar}" method="post">
                            <div class="modal-body">
                                <!-- Campo oculto para el código -->
                                <input type="hidden" id="editClienteCodigo" name="codigo">

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="editClienteNombre" class="form-label">Nombre Completo *</label>
                                        <input type="text" class="form-control" id="editClienteNombre" name="nombre" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="editClienteEmail" class="form-label">Email</label>
                                        <input type="email" class="form-control" id="editClienteEmail" name="email">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="editClienteTelefono" class="form-label">Teléfono</label>
                                        <input type="tel" class="form-control" id="editClienteTelefono" name="telefono">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="editClienteIdentificacion" class="form-label">Identificación *</label>
                                        <input type="text" class="form-control" id="editClienteIdentificacion" name="identificacion" required>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12 mb-3">
                                        <label for="editClienteDireccion" class="form-label">Dirección</label>
                                        <textarea class="form-control" id="editClienteDireccion" name="direccion" rows="3"></textarea>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="editClienteUsername" class="form-label">Username *</label>
                                        <input type="text" class="form-control" id="editClienteUsername" name="username" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="editClienteDireccionFisica" class="form-label">Dirección Física</label>
                                        <input type="text" class="form-control" id="editClienteDireccionFisica" name="direccionFisica">
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="submit" class="btn btn-warning">
                                    <i class='bx bx-save'></i> Guardar Cambios
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>
<!-- Modal de confirmación de cierre de sesión -->
<div id="confirmLogoutModal" class="modal fade" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #e74c3c, #c0392b); color: white;">
                <h5 class="modal-title"><i class='bx bx-power-off'></i> Cerrar sesión</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body text-center">
                <p class="mb-3">¿Estás seguro que deseas cerrar la sesión?</p>
                <p class="text-muted" style="font-size: 0.9rem;">Se te redirigirá a la pantalla de login.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmLogoutBtn">Cerrar sesión</button>
            </div>
        </div>
    </div>
</div>

<script>
    (function(){
        const btn = document.getElementById('confirmLogoutBtn');
        if(btn){
            btn.addEventListener('click', function(){
                window.location.href = '/logout';
            });
        }
    })();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Variables globales
    let isLoading = false;

    // Toggle sidebar con mejoras para móviles
    document.getElementById('toggleSidebar').addEventListener('click', function() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');

        if (window.innerWidth <= 992) {
            sidebar.classList.toggle('show');
            overlay.classList.toggle('show');
        } else {
            sidebar.classList.toggle('hidden');
        }
    });

    // Cerrar sidebar al hacer clic en overlay (móviles)
    document.getElementById('sidebarOverlay').addEventListener('click', function() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.remove('show');
        this.classList.remove('show');
    });

    // Cerrar el sidebar al hacer clic en un enlace (en móviles)
    document.querySelectorAll('#sidebar .nav-link').forEach(link => {
        link.addEventListener('click', function() {
            if (window.innerWidth <= 992) {
                document.getElementById('sidebar').classList.remove('show');
                document.getElementById('sidebarOverlay').classList.remove('show');
            }
        });
    });

    // Rellenar modal de visualización de cliente
    const verClienteModal = document.getElementById('verClienteModal');
    verClienteModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;

        // Función para formatear valores nulos
        const formatValue = (value) => value || 'No disponible';

        document.getElementById('viewClienteCodigo').textContent = formatValue(button.getAttribute('data-codigo'));
        document.getElementById('viewClienteNombre').textContent = formatValue(button.getAttribute('data-nombre'));
        document.getElementById('viewClienteEmail').textContent = formatValue(button.getAttribute('data-email'));
        document.getElementById('viewClienteTelefono').textContent = formatValue(button.getAttribute('data-telefono'));
        document.getElementById('viewClienteIdentificacion').textContent = formatValue(button.getAttribute('data-identificacion'));
        document.getElementById('viewClienteDireccion').textContent = formatValue(button.getAttribute('data-direccion'));
    });

    // Rellenar modal de edición de cliente
    const editarClienteModal = document.getElementById('editarClienteModal');
    editarClienteModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;

        // Función para formatear valores nulos (vacío si es null/undefined)
        const formatValue = (value) => value || '';

        // Llenar los campos del formulario con los datos del cliente
        document.getElementById('editClienteCodigo').value = formatValue(button.getAttribute('data-codigo'));
        document.getElementById('editClienteNombre').value = formatValue(button.getAttribute('data-nombre'));
        document.getElementById('editClienteEmail').value = formatValue(button.getAttribute('data-email'));
        document.getElementById('editClienteTelefono').value = formatValue(button.getAttribute('data-telefono'));
        document.getElementById('editClienteIdentificacion').value = formatValue(button.getAttribute('data-identificacion'));
        document.getElementById('editClienteDireccion').value = formatValue(button.getAttribute('data-direccion'));
        document.getElementById('editClienteUsername').value = formatValue(button.getAttribute('data-username'));
        document.getElementById('editClienteDireccionFisica').value = formatValue(button.getAttribute('data-direccionfisica'));
    });

    // Auto-focus en el primer campo del modal de agregar
    const agregarModal = document.getElementById('agregarClienteModal');
    agregarModal.addEventListener('shown.bs.modal', function() {
        this.querySelector('#codigo').focus();
    });

    // Auto-focus en el primer campo del modal de edición
    editarClienteModal.addEventListener('shown.bs.modal', function() {
        this.querySelector('#editClienteNombre').focus();
    });

    // Cambiar tamaño de página
    function changePageSize(select) {
        if (isLoading) return;

        const size = select.value;
        const url = new URL(window.location.href);
        url.searchParams.set('size', size);
        url.searchParams.set('page', '0'); // Volver a primera página
        showLoading();
        window.location.href = url.toString();
    }

    // Mostrar loading
    function showLoading() {
        isLoading = true;
        document.getElementById('loadingSpinner').style.display = 'block';
        document.getElementById('clientesTable').style.opacity = '0.5';
    }

    // Ocultar loading
    function hideLoading() {
        isLoading = false;
        document.getElementById('loadingSpinner').style.display = 'none';
        document.getElementById('clientesTable').style.opacity = '1';
    }

    // Recargar lista usando fetch API
    document.getElementById('reloadBtn').addEventListener('click', function() {
        if (isLoading) return;

        showLoading();

        // Simular recarga (en un caso real, aquí harías fetch a la API)
        setTimeout(() => {
            window.location.reload();
        }, 500);
    });

    // Event delegation para los botones de acción
    document.addEventListener('DOMContentLoaded', function() {
        // Event delegation para botones de editar - SOLO PREVENIR COMPORTAMIENTO POR DEFECTO
        document.addEventListener('click', function(e) {
            if (e.target.closest('.edit-client-btn')) {
                // Ya no redirigimos, el modal se abre automáticamente con data-bs-toggle
                e.preventDefault();
            }
        });

        // Event delegation para botones de eliminar
        document.addEventListener('click', function(e) {
            if (e.target.closest('.delete-client-btn')) {
                const button = e.target.closest('.delete-client-btn');
                const codigo = button.getAttribute('data-codigo');
                const nombre = button.getAttribute('data-nombre');

                if (confirm('¿Está seguro de que desea eliminar al cliente "' + nombre + '"?')) {
                    showLoading();
                    // Crear formulario dinámico para eliminar
                    const form = document.createElement('form');
                    form.method = 'post';
                    form.action = '/clientes/eliminar';

                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'codigo';
                    input.value = codigo;

                    form.appendChild(input);
                    document.body.appendChild(form);
                    form.submit();
                }
            }
        });

        // Auto-cerrar alertas después de 5 segundos
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(alert => {
            setTimeout(() => {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }, 5000);
        });

        // Efecto de elevación para los botones de acción
        const actionButtons = document.querySelectorAll('.btn-action');
        actionButtons.forEach(button => {
            button.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-2px)';
                this.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
            });

            button.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = 'none';
            });
        });

        // Efecto de animación para las tarjetas de estadísticas
        const statsCards = document.querySelectorAll('.stats-card');
        statsCards.forEach(card => {
            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-5px)';
            });

            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
            });
        });
    });

    // Validación básica del formulario de agregar
    document.getElementById('agregarClienteForm')?.addEventListener('submit', function(e) {
        const codigo = this.querySelector('input[name="codigo"]').value.trim();
        const nombre = this.querySelector('input[name="nombre"]').value.trim();
        const identificacion = this.querySelector('input[name="identificacion"]').value.trim();
        const username = this.querySelector('input[name="username"]').value.trim();

        if (!codigo || !nombre || !identificacion || !username) {
            e.preventDefault();
            alert('Por favor complete todos los campos obligatorios (*)');
            return false;
        }

        showLoading();
        return true;
    });

    // Validación del formulario de edición
    document.getElementById('editarClienteForm')?.addEventListener('submit', function(e) {
        const nombre = this.querySelector('#editClienteNombre').value.trim();
        const identificacion = this.querySelector('#editClienteIdentificacion').value.trim();
        const username = this.querySelector('#editClienteUsername').value.trim();

        if (!nombre || !identificacion || !username) {
            e.preventDefault();
            alert('Por favor complete todos los campos obligatorios (*)');
            return false;
        }

        showLoading();
        return true;
    });

    // Agregar clase es-admin al body si es administrador
    document.addEventListener('DOMContentLoaded', function() {
        const adminElements = document.querySelectorAll('.admin-only');
        if (adminElements.length > 0 && adminElements[0].style.display !== 'none') {
            document.body.classList.add('es-admin');
        }
    });

    // Mostrar loading al enviar formularios
    document.querySelectorAll('form').forEach(form => {
        form.addEventListener('submit', function() {
            showLoading();
        });
    });

    // Mejora: Limpiar formulario cuando se cierra el modal de agregar
    agregarModal.addEventListener('hidden.bs.modal', function() {
        this.querySelector('form').reset();
    });

    // Efecto de animación para el modal al abrir
    verClienteModal.addEventListener('show.bs.modal', function() {
        this.style.animation = 'fadeIn 0.3s ease-out';
    });

    editarClienteModal.addEventListener('show.bs.modal', function() {
        this.style.animation = 'fadeIn 0.3s ease-out';
    });

    // Manejo de responsive al cambiar tamaño de ventana
    window.addEventListener('resize', function() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');

        if (window.innerWidth > 992) {
            sidebar.classList.remove('show');
            overlay.classList.remove('show');
        }
    });

    // Inicialización cuando el DOM está listo
    document.addEventListener('DOMContentLoaded', function() {
        // Aplicar animaciones de entrada
        const elements = document.querySelectorAll('.fade-in');
        elements.forEach((element, index) => {
            element.style.animationDelay = `${index * 0.1}s`;
        });

        console.log('Vista de gestión de clientes cargada correctamente');
    });
</script>
</body>
</html>